<!-- Fase 4 Section - IA Predictiva -->
<div class="content-section" id="fase4">
    <h2><i class="fas fa-robot"></i> Análisis Predictivo de Rutas Logísticas</h2>
    <p style="color:#cbd5e1; margin-bottom:20px;">
        Sube una captura de pantalla de la ruta de la Fase 2 para generar su informe logístico.
    </p>
    <!-- FORMULARIO PARA SUBIR IMAGEN -->
    <div class="ia-form" style="margin-top:20px;">
        <h3><i class="fas fa-image"></i> Subir Captura de Pantalla</h3>
        <input type="file" id="imagen-captura" accept="image/*" style="padding: 12px 20px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 12px; color: #f1f5f9; font-size: 1rem; width: 100%; margin-bottom: 15px;">
        <button onclick="analizarImagen()" class="card-button" style="width: 100%;">
            <i class="fas fa-brain"></i> Analizar Imagen con IA
        </button>
    </div>
    <!-- RESULTADOS DEL ANALISIS -->
    <div class="results-container" id="ia-results" style="margin-top:25px; display: none;">
        <h4><i class="fas fa-file-alt"></i> Informe de la Ruta Logística</h4>
        <div class="result-item"><span class="info-label">Producto:</span> <span class="info-value" id="resultado-producto">-</span></div>
        <div class="result-item"><span class="info-label">Origen:</span> <span class="info-value" id="resultado-origen">-</span></div>
        <div class="result-item"><span class="info-label">Destino:</span> <span class="info-value" id="resultado-destino">-</span></div>
        <div class="result-item"><span class="info-label">Tipo de Transporte:</span> <span class="info-value" id="resultado-transporte">-</span></div>
        <div class="result-item"><span class="info-label">Distancia Total:</span> <span class="info-value" id="resultado-distancia">-</span></div>
        <div class="result-item"><span class="info-label">Vía Principal:</span> <span class="info-value" id="resultado-via">-</span></div>
        <div class="result-item"><span class="info-label">Descripción del Proceso:</span> <span class="info-value" id="resultado-descripcion">-</span></div>
        <button class="download-btn" onclick="descargarPDF()">
            <i class="fas fa-file-pdf"></i> Descargar Informe (PDF)
        </button>
    </div>
</div>

<script>
// === CONFIGURACIÓN DE OPENAI ===
// ⚠️ PON TU CLAVE AQUÍ ⚠️
const OPENAI_API_KEY = "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"; // Reemplaza esto con tu clave real de OpenAI

async function analizarImagen() {
    const input = document.getElementById('imagen-captura');
    const file = input.files[0];
    
    if (!file) {
        alert("Por favor, selecciona una imagen.");
        return;
    }

    try {
        // Mostrar mensaje de carga
        document.getElementById('ia-results').style.display = 'none';
        const loadingDiv = document.createElement('div');
        loadingDiv.style.textAlign = 'center';
        loadingDiv.innerHTML = '<p style="color: #fbbf24; font-weight: 600;">Analizando la imagen... Esto puede tardar unos segundos.</p>';
        document.querySelector('.ia-form').after(loadingDiv);

        // Convertir la imagen a Base64
        const reader = new FileReader();
        reader.onload = async function(e) {
            const base64Image = e.target.result.split(',')[1]; // Extraer solo los datos Base64
            
            // Enviar la imagen a OpenAI
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o", // Modelo que soporta visión
                    messages: [
                        {
                            "role": "user",
                            "content": [
                                {
                                    "type": "text",
                                    "text": "Analiza esta imagen de una ruta logística. Identifica: \n1. El producto que se está transportando.\n2. El origen (ciudad y puerto).\n3. El destino (ciudad y puerto).\n4. El tipo de transporte (marítimo, terrestre, aéreo).\n5. La distancia total aproximada.\n6. La vía principal (por ejemplo, Canal de Panamá, Ruta Pacífica).\n7. Una descripción del proceso logístico desde la producción hasta la entrega.\n\nDevuelve la respuesta en formato JSON con las claves: producto, origen, destino, transporte, distancia, via, descripcion."
                                },
                                {
                                    "type": "image_url",
                                    "image_url": {
                                        "url": `data:image/jpeg;base64,${base64Image}`
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 500
                })
            });

            // Quitar el mensaje de carga
            loadingDiv.remove();

            if (!response.ok) {
                throw new Error(`Error de OpenAI: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            // Procesar la respuesta
            let analysis;
            try {
                // Intentar parsear la respuesta como JSON
                analysis = JSON.parse(data.choices[0].message.content);
            } catch (e) {
                // Si falla, usar la respuesta completa como descripción
                analysis = {
                    producto: "No identificado",
                    origen: "No identificado",
                    destino: "No identificado",
                    transporte: "No identificado",
                    distancia: "No identificada",
                    via: "No identificada",
                    descripcion: data.choices[0].message.content
                };
            }

            // Actualizar la interfaz con los resultados
            document.getElementById('resultado-producto').textContent = analysis.producto || "-";
            document.getElementById('resultado-origen').textContent = analysis.origen || "-";
            document.getElementById('resultado-destino').textContent = analysis.destino || "-";
            document.getElementById('resultado-transporte').textContent = analysis.transporte || "-";
            document.getElementById('resultado-distancia').textContent = analysis.distancia || "-";
            document.getElementById('resultado-via').textContent = analysis.via || "-";
            document.getElementById('resultado-descripcion').textContent = analysis.descripcion || "-";

            // Mostrar los resultados
            document.getElementById('ia-results').style.display = 'block';

        };

        reader.readAsDataURL(file);

    } catch (error) {
        console.error('Error:', error);
        alert(`Ocurrió un error al analizar la imagen: ${error.message}`);
    }
}

function descargarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Título
    doc.setFontSize(20);
    doc.text("Informe de Ruta Logística", 20, 20);
    
    // Datos
    doc.setFontSize(12);
    doc.text(`Producto: ${document.getElementById('resultado-producto').textContent}`, 20, 40);
    doc.text(`Origen: ${document.getElementById('resultado-origen').textContent}`, 20, 55);
    doc.text(`Destino: ${document.getElementById('resultado-destino').textContent}`, 20, 70);
    doc.text(`Tipo de Transporte: ${document.getElementById('resultado-transporte').textContent}`, 20, 85);
    doc.text(`Distancia Total: ${document.getElementById('resultado-distancia').textContent}`, 20, 100);
    doc.text(`Vía Principal: ${document.getElementById('resultado-via').textContent}`, 20, 115);
    doc.text(`Descripción:`, 20, 130);
    
    // Descripción (con salto de línea si es necesario)
    const descripcion = document.getElementById('resultado-descripcion').textContent;
    const lines = doc.splitTextToSize(descripcion, 170); // Ajusta el ancho según necesites
    doc.text(lines, 20, 140);
    
    // Guardar el PDF
    doc.save('informe_ruta_logistica.pdf');
}
</script>
